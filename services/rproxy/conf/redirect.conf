ServerName rproxy.42.fr
SSLSessionCache shmcb:/run/httpd/sslcache(512000)
SSLSessionCacheTimeout 300

SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
Listen 443 https
Listen 8080

ExtendedStatus On

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName 42.fr
    ServerAlias transcendence.42.fr pong.42.fr grafana.42.fr prometheus.42.fr vault.42.fr elastic.42.fr kibana.42.fr cadvisor.42.fr rproxy.42.fr

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [R=301,L]

</VirtualHost>

<VirtualHost *:443>
    ServerName transcendence.42.fr
    ServerAlias pong.42.fr

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
    SSLProtocol TLSv1.2 TLSv1.3

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set Host %{HTTP_HOST}s

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    # ---------------------------
    # API routes (must come first)
    # ---------------------------

    # GAME (WebSocket + HTTP fallback)
    ProxyPassMatch ^/api/game/(.*) ws://game-service:3601/$1 nocanon retry=0
    ProxyPassReverse /api/game/ ws://game-service:3601/
    ProxyPass /api/game/ http://game-service:3601/ nocanon retry=0
    ProxyPassReverse /api/game/ http://game-service:3601/
    RedirectMatch 301 ^/api/game$ /api/game/

    # SCOREBOARD
    ProxyPass /api/scoreboard/ http://scoreboard-service:3602/ nocanon retry=0
    ProxyPassReverse /api/scoreboard/ http://scoreboard-service:3602/
    RedirectMatch 301 ^/api/scoreboard$ /api/scoreboard/

    # Block /api/scoreboard/score
    <LocationMatch "^/api/scoreboard/score$">
        <Limit POST>
            Require all denied
        </Limit>
    </LocationMatch>

    # TOURNAMENT
    ProxyPass /api/tournament/ http://tournament-service:3603/ nocanon retry=0
    ProxyPassReverse /api/tournament/ http://tournament-service:3603/
    RedirectMatch 301 ^/api/tournament$ /api/tournament/

    # ---------------------------
    # Frontend (fallback)
    # ---------------------------
    ProxyPass / http://frontend:80/
    ProxyPassReverse / http://frontend:80/

</VirtualHost>

<VirtualHost *:8080>
    ServerName rproxy

    <Location "/server-status">
        SetHandler server-status
        Require all granted
    </Location>
</VirtualHost>

<VirtualHost *:443>
    ServerName grafana.42.fr

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
    SSLProtocol TLSv1.2 TLSv1.3

    ProxyPreserveHost On
    ProxyPass / https://grafana:3000/
    ProxyPassReverse / https://grafana:3000/

    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set Host %{HTTP_HOST}s

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
</VirtualHost>

<VirtualHost *:443>
    ServerName prometheus.42.fr

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
    SSLProtocol TLSv1.2 TLSv1.3

    ProxyPreserveHost On
    ProxyPass / http://prometheus:9090/
    ProxyPassReverse / http://prometheus:9090/

    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set Host %{HTTP_HOST}s
</VirtualHost>

<VirtualHost *:443>
    ServerName vault.42.fr

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
    SSLProtocol TLSv1.2 TLSv1.3

    ProxyPreserveHost On
    ProxyPass / https://vault:8200/
    ProxyPassReverse / https://vault:8200/

    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set Host %{HTTP_HOST}s

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
</VirtualHost>

<VirtualHost *:443>
    ServerName elastic.42.fr
    ServerAlias kibana.42.fr

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
    SSLProtocol TLSv1.2 TLSv1.3

    ProxyPreserveHost On
    ProxyPass / https://kibana:5601/
    ProxyPassReverse / https://kibana:5601/

    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set Host %{HTTP_HOST}s

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
</VirtualHost>

<VirtualHost *:443>
    ServerName cadvisor.42.fr

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/rproxy.crt
    SSLCertificateKeyFile /etc/pki/tls/certs/rproxy.key
    SSLProtocol TLSv1.2 TLSv1.3

    ProxyPreserveHost On
    ProxyPass / http://cadvisor:8080/
    ProxyPassReverse / http://cadvisor:8080/

    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set Host %{HTTP_HOST}s

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
</VirtualHost>
